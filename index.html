<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥µç°¡æ·±è‰²è³“æœ - å°ˆæ¥­ç‰ˆ</title>
    <style>
        /* --- åŸºç¤è®Šæ•¸èˆ‡é‡ç½® --- */
:root {
    --bg-color: #121212;
    --card-bg: #1e1e1e;
    --text-color: #e0e0e0;
    --accent-red: rgba(255, 68, 68, 0.7);
    --accent-green: #51cf66;
    --accent-cancel: #c92a2a;
    --pending-color: #fcc419;
    --line-color: #51cf66;
    --border-color: #333;
}

body {
    background-color: var(--bg-color);
    color: var(--text-color);
    font-family: -apple-system, "Microsoft JhengHei", sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 0;
    padding: 30px 20px;
    min-height: 100vh; /* ç¢ºä¿ body è‡³å°‘è·Ÿè¢å¹•ä¸€æ¨£é«˜ */
    height: auto;      /* å…è¨± body æ ¹æ“šå…§å®¹è‡ªå‹•ä¼¸å±• */
    overflow-y: auto;  /* å¦‚æœå…§å®¹å¤ªé•·ï¼Œå…è¨±æ²å‹• */
}

/* --- é ‚éƒ¨å€åŸŸèˆ‡æŒ‡ç¤ºç‡ˆ --- */
.header-section {
    display: flex;
    justify-content: space-between; /* å·¦ä¸­å³åˆ†é–‹ */
    align-items: flex-start; /* è®“ä¸­é–“å®¹å™¨å¾ä¸Šæ–¹é–‹å§‹æ’åˆ— */
    margin-bottom: 10px;
}
.status-container {
    display: flex;
    flex-direction: column; /* å‚ç›´æ’åˆ—ï¼šç¬¬ä¸€è¡Œæ˜¯æ¨¡å¼/åˆ†æ•¸/äººæ•¸ï¼Œç¬¬äºŒè¡Œæ˜¯ turn-indicator */
    align-items: center;    /* ç½®ä¸­é¡¯ç¤º */
}

.status-bar {
    display: flex;
    justify-content: center;   /* æ°´å¹³ç½®ä¸­æ•´çµ„ */
    align-items: center;       /* å‚ç›´ç½®ä¸­æ¯å€‹å…ƒç´  */

    gap: 8px;
    margin-bottom: 4px;     /* èˆ‡ turn-indicator ç•™ä¸€é»è·é›¢ */
}

.score-bar {
    font-size: 1.1rem;
    color: var(--line-color);
    font-weight: bold;
}
.mini-tag {
    font-size: 10px;
    color: #8a8a8a;
    letter-spacing: 1px;
    background: rgba(255,255,255,0.03);
    padding: 2px 8px;
    border-radius: 4px;
}

.main-status-area {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 60px;
}

.turn-label {
    display: inline-block;
    padding: 8px 24px;
    border-radius: 25px;
    font-size: 0.9rem;
    font-weight: bold;
    text-align: center;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.05);
    color: var(--line-color);/*#888*/
    border: 1px solid transparent;
    margin-top: 10px;
}

.active-turn { animation: pulse-border 1.5s infinite ease-in-out; }
@keyframes pulse-border {
    0% { transform: scale(1); }
    50% { transform: scale(1.08); }
    100% { transform: scale(1); }
}

.sub-info-row { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }

/* ç©å®¶é¡è‰²æ¨£å¼ */
.turn-player-1 { color: #ff4444; background: rgba(255, 68, 68, 0.1); border-color: rgba(255, 68, 68, 0.3); }
.turn-player-2 { color: #4dabf7; background: rgba(77, 171, 247, 0.1); border-color: rgba(77, 171, 247, 0.3); }
.turn-player-3 { color: rgb(239, 255, 114); background: rgba(239, 255, 114, 0.1); border-color: rgba(239, 255, 114, 0.3); }
.turn-cpu { color: rgb(146, 88, 238); background: rgba(146, 88, 238, 0.1); border-color:rgba(146, 88, 238, 0.3); }

/* --- éŠæˆ²ç›¤é¢èˆ‡æ ¼å­ --- */
.grid-container {
    position: relative;
    display: grid;
    gap: 6px;
    padding: 10px;
    background: #252525;
    border-radius: 8px;
    margin-top: 10px;/*æ§åˆ¶ä¸Šé‚Šè·*/
    margin-bottom: 10px;/*æ§åˆ¶ä¸‹é‚Šè·*/
}

.cell {
    background: var(--card-bg);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: relative;
    font-weight: 500;
    transition: all 0.2s;
    overflow: hidden;
}

/* ç©å®¶åœ“åœˆæ¨™è¨˜ */
.cell::after {
    content: '';
    position: absolute;
    width: 65%;
    height: 65%;
    border-radius: 50%;
    z-index: 1;
    display: none;
}
.cell.player-1::after { display: block; background: rgba(255, 68, 68, 0.7); }
.cell.player-2::after { display: block; background: rgba(77, 171, 247, 0.7); }
.cell.player-3::after { display: block; background: rgba(239, 255, 114, 0.7); }
.cell.player-cpu::after { display: block; background: rgba(146, 88, 238, 0.4); }

.cell.pending { outline: 2px dashed var(--pending-color); outline-offset: -4px; color: var(--pending-color); }
#lineCanvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 2; }

/* --- æ§åˆ¶æŒ‰éˆ•èˆ‡é é¢ --- */
.controls {
    width: 100%;
    max-width: 280px;
    min-height: 50px; /* çµ¦äºˆæœ€å°é«˜åº¦ */
    margin-top: 0px;/*æ§åˆ¶ä¸Šç·¨åŠ‡*/
    overflow: visible ; /* é˜²æ­¢å…§å®¹è¢«åˆ‡æ‰ */
}
.page {
    display: none;
    width: 100%;
}
.page.active {
    display: flex ;   /* ä½¿ç”¨ flex æˆ– block ç¢ºä¿é¡¯ç¤º */
    flex-direction: column;
    align-items: center;
    gap: 10px;
    visibility: visible ;
    opacity: 1 ;
}
.page.active * {
    visibility: visible;
}
.btn-row { display: flex; 
    justify-content: space-between; 
    gap: 10px; margin-top: 5px;
align-items: stretch;/* æ–°å¢é€™è¡Œï¼Œè®“å…§éƒ¨çš„æŒ‰éˆ•è‡ªå‹•æ‹‰ä¼¸åˆ°ç›¸åŒé«˜åº¦ */
 }

button {
    background: rgba(255, 255, 255, 0.05); color: var(--text-color);
    border: 1px solid #444; border-radius: 6px; padding: 10px 15px;
    cursor: pointer; font-size: 14px; transition: all 0.2s;box-sizing: border-box; /* æ–°å¢é€™è¡Œï¼Œç¢ºä¿é‚Šæ¡†ä¸æœƒæ’å¤§é«˜åº¦ */
}
button:disabled { opacity: 0.2; cursor: not-allowed; }
button.active { background: var(--line-color); color: #121212; border-color: var(--line-color); font-weight: bold; box-shadow: 0 0 10px rgba(81, 207, 102, 0.3); }

.btn-confirm { border-color: var(--accent-green); color: var(--accent-green); }
.btn-cancel { border-color: var(--accent-cancel); color: var(--accent-cancel); }
.btn-start { border-color: var(--line-color); color: var(--line-color); font-weight: bold; }
.btn-restart {
    width: 100%;
    margin-top: 0px;        /* å°‡åŸæœ¬çš„ 8px æ”¹ç‚º 0ï¼Œé¿å…æ¨æ“  */
    /*border-style: dashed;    ä¿ç•™ä½ çš„è™›ç·šæ¨£å¼ */
    border-color:var(--line-color); 
    color: var(--line-color);
    height: 100%;           /* ç¢ºä¿å¡«æ»¿çˆ¶å®¹å™¨é«˜åº¦ */
    display: flex;
    align-items: center;
    justify-content: center;
}

.confirm-row { 
    display: flex; align-items: center; justify-content: space-between; 
    background: #1a1a1a; padding: 10px 15px; border-radius: 8px; border: 1px solid #333;gap : 20px;
}
.display-box { font-size: 1.4rem; font-weight: bold; color: var(--pending-color); min-width: 40px; text-align: center; }

/* --- å½ˆçª—ã€è¨­å®šèˆ‡ç´€éŒ„ (åŒ…å«ç¸®å°å­—é«”) --- */
.info-overlay, .overlay {
    display: none; position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); 
    background: rgba(20, 20, 20, 0.98); padding: 25px; border: 1px solid var(--line-color); 
    border-radius: 12px; z-index: 200; width: 260px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.8);
}

.settings-row { margin-bottom: 12px; text-align: left; }
.settings-label { display: block; font-size: 11px; color: #888; margin-bottom: 4px; } /* ç¸®å°è¨­å®šé é¢æ¨™ç±¤ */
.btn-group { display: flex; gap: 4px; }
.btn-group button { flex: 1; padding: 5px; font-size: 11px; } /* ç¸®å°è¨­å®šæŒ‰éˆ•å­—é«” */

.info-title { font-weight: bold; color: var(--line-color); margin-bottom: 15px; display: block; font-size: 16px; }
.info-content { font-size: 0.85rem; color: #ccc; line-height: 1.6; margin-bottom: 20px; }

/* å°æˆ°ç´€éŒ„åˆ—è¡¨ */
#logList { 
    margin: 15px 0; max-height: 150px; overflow-y: auto; font-size: 0.8rem; text-align: left; 
    padding-right: 5px;
}
#logList::-webkit-scrollbar { width: 4px; }
#logList::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }

/* è³“æœç‰¹æ•ˆæ–‡å­— */
.bingo-text { font-size: 2.2rem; font-weight: bold; color: var(--line-color); display: block; margin-bottom: 10px; animation: blink 1s infinite; text-shadow: 0 0 15px var(--line-color); }
@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

/* --- åœ–ç¤ºèˆ‡æ„Ÿæ‡‰å€ --- */
.info-icon { 
    position: absolute; top: 20px; left: 20px; width: 22px; height: 22px; 
    border: 1px solid #555; border-radius: 50%; display: flex; align-items: center; 
    justify-content: center; font-size: 14px; color: #555; cursor: pointer;
}

.top-actions { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; }
.action-icon { 
    font-size: 22px; color: #555; cursor: pointer; 
    padding: 15px; margin: -15px; /* æ“´å¤§é»æ“Šæ„Ÿæ‡‰å€ */
}

/* --- é å°¾ --- */
.footer-info { width: 100%; text-align: center; font-size: 10px; color: #444; margin-top: 20px; padding-bottom: 20px; letter-spacing: 0.5px; }

    </style>
</head>

<body>
<div class="header-section">
    <div class="info-icon" onclick="toggleInfo(true)">i</div>

    <div class="status-container">
        <div class="status-bar">
            <span id="mode-display" class="mini-tag">PVP</span>
            <span class="score-bar">SCORE: <span id="score">0</span></span>
            <span id="players-display" class="mini-tag">2äºº</span>
        </div>
        <div id="turn-indicator" class="turn-label">âœï¸ å¡«å¯«è™Ÿç¢¼ä¸­</div>
    </div>

    <div class="top-actions">
        <div class="action-icon" onclick="toggleSettings(true)">â‹®</div>
    </div>
</div>

    <div class="grid-container" id="grid">
        <canvas id="lineCanvas"></canvas>
    </div>

    <div class="controls">
        <div id="page1" class="page active">
            <div class="btn-row">
                <button onclick="clearAll()" style="flex:1">å…¨éƒ¨æ¸…é™¤</button>
                <button onclick="randomFill()" style="flex:1">éš¨æ©Ÿå¡«å¯«</button>
            </div>
            <div class="btn-row">
                <button id="startBtn" class="btn-start" onclick="startGame()" disabled style="width: 100%;">é–‹å§‹éŠæˆ²</button>
            </div>
        </div>

        <div id="page2" class="page">
            <div class="confirm-row">
                <button class="btn-cancel" onclick="cancelSelect()">X</button>
                <div class="display-box" id="displayBox">-</div>
                <button class="btn-confirm" onclick="confirmSelect()">O</button>
            </div>
            <div class="btn-row">
                <button onclick="toggleHistory(true)" style="flex:1">å°æˆ°ç´€éŒ„</button>
                <button id="restartBtn" class="btn-restart" onclick="resetGame()" style="flex:1">é‡å•ŸéŠæˆ²</button>
            </div>
        </div>
    </div>

    <div id="infoBox" class="info-overlay">
        <span style="color:var(--line-color); font-weight:bold;">æ“ä½œèªªæ˜</span><br><br>
        <div style="text-align:left; font-size:0.9rem; line-height:1.6; color:#ccc;">
            <b>å¡«å¯«æ¨¡å¼:</b> é»æ“Šæ ¼å­å¡«è™Ÿï¼Œå¡«æ»¿å¾ŒæŒ‰é–‹å§‹ã€‚<br>
            <b>éŠæˆ²æ¨¡å¼:</b> é»æ“Šæ•¸å­—å¾ŒæŒ‰ O ç¢ºèªã€‚
        </div><br>
        <button onclick="toggleInfo(false)" style="width: 100%;">æˆ‘çŸ¥é“äº†</button>
    </div>

    <div id="settingsBox" class="info-overlay">
        <span style="color:var(--line-color); font-weight:bold;">éŠæˆ²è¨­å®š</span><br><br>
        <div class="settings-row">
            <span class="settings-label">æ¨¡å¼</span>
            <div class="btn-group">
                <button id="modePVP" class="active" onclick="setMode('PVP')">çœŸäººå°æˆ°</button>
                <button id="modePVE" onclick="setMode('PVE')">é›»è…¦é™ªç©</button>
            </div>
        </div>
        <div class="settings-row">
            <span class="settings-label">äººæ•¸</span>
            <div class="btn-group">
                <button id="p2" class="active" onclick="setPlayers(2)">2äºº</button>
                <button id="p3" onclick="setPlayers(3)">3äºº</button>
            </div>
        </div>

        <div class="settings-row">
        <span class="settings-label">ä½ çš„é †ä½ (ç¬¬å¹¾å€‹å–Š)</span>
        <div class="btn-group">
            <button id="order1" class="active" onclick="setOrder(1)">1</button>
            <button id="order2" onclick="setOrder(2)">2</button>
            <button id="order3" onclick="setOrder(3)">3</button>
        </div>
    </div>

        
        <div class="settings-row">
            <span class="settings-label">æ ¼å­å¤§å°</span>
            <div class="btn-group">
                <button id="size5" class="active" onclick="setSize(5)">5X5</button>
                <button id="size7" onclick="setSize(7)">7X7</button>
            </div>
        </div>
        <div class="btn-row"><button onclick="applySettings()" style="width: 100%; border-color:var(--line-color);">å¥—ç”¨ä¸¦é‡ç½®</button></div>
    </div>

    <div id="historyBox" class="info-overlay">
        <span style="color:var(--line-color); font-weight:bold;">å°æˆ°ç´€éŒ„</span>
        <div id="logList" style="margin:15px 0; max-height:150px; overflow-y:auto; font-size:0.8rem; text-align:left;"></div>
        <button onclick="toggleHistory(false)" style="width: 100%;">é—œé–‰</button>
    </div>

    <div id="gameOver" class="overlay" onclick="this.style.display='none'">
        <span class="bingo-text" id="winLossText">BINGO!</span>
        <div style="font-size:0.8rem; color:#888;">éŠæˆ²çµæŸï¼Œè«‹é‡å•ŸéŠæˆ²æˆ–æŸ¥é–±å°æˆ°ç´€éŒ„ã€‚<br>æœ¬è¦–çª—é»æ“Šå¾Œé—œé–‰</div>
    </div>

    <footer class="footer-info">
        <div>&copy; 2026 Jan Hahajeff. All Rights Reserved.</div>
        <div style="opacity: 0.5;">Powered by Gemini AI | Version 2.0</div>
    </footer>

    <script>
// åŸºç¤éŠæˆ²ç‹€æ…‹
    let state = 'FILL'; 
    let gridSize = 5; 
    let gameMode = 'PVP'; 
    let playerCount = 2; 
    let myOrder = 1;      // <--- è£œå›é€™è¡Œï¼Œé è¨­ä½ æ˜¯ç¬¬ 1 é †ä½
    let currentTurn = 1; 

    // ç›¤é¢è³‡æ–™
    let board = []; 
    let selectedIndices = new Set(); 
    let cpuBoard = []; 
    let cpuSelectedIndices = new Set(); 
    let historyLog = []; 
    let pendingChoice = null;
    // ç¶²é è¼‰å…¥å®Œæˆæ™‚åˆå§‹åŒ–
    window.onload = function() {
    resetGame();
    };

        const grid = document.getElementById('grid'), scoreEl = document.getElementById('score'), startBtn = document.getElementById('startBtn'), restartBtn = document.getElementById('restartBtn'), displayBox = document.getElementById('displayBox'), canvas = document.getElementById('lineCanvas'), ctx = canvas.getContext('2d');

        function initGrid() {
            grid.querySelectorAll('.cell').forEach(el => el.remove());
            const total = gridSize * gridSize; board = Array(total).fill(null);
            const cellSize = gridSize === 5 ? 52 : 38;
            grid.style.gridTemplateColumns = `repeat(${gridSize}, ${cellSize}px)`;
            const side = (cellSize * gridSize) + (6 * (gridSize - 1)) + 20;
            canvas.width = side; canvas.height = side;

            for (let i = 0; i < total; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.style.width = cell.style.height = cellSize + 'px';
                cell.style.fontSize = gridSize === 5 ? '20px' : '14px';
                cell.onclick = () => handleCellClick(i);
                grid.appendChild(cell);
            }
        }

        function updateStatusDisplay() {
            document.getElementById('mode-display').innerText = gameMode;
            document.getElementById('players-display').innerText = playerCount + 'äºº';
        }

        function setOrder(order) {
    myOrder = order; // æ›´æ–°å…¨åŸŸè®Šæ•¸

    // æ›´æ–° UI æ¨£å¼
    document.getElementById('order1').classList.remove('active');
    document.getElementById('order2').classList.remove('active');
    document.getElementById('order3').classList.remove('active');
    document.getElementById('order' + order).classList.add('active');

    // å¦‚æœéœ€è¦é¡¯ç¤ºåœ¨ç‹€æ…‹åˆ—ï¼Œå¯ä»¥å‘¼å« updateStatusDisplay()
    updateStatusDisplay();
}

        function handleCellClick(i) {
            if (state === 'FILL') {
                if (board[i] === null) { if (board.filter(x=>x).length < gridSize*gridSize) board[i] = board.filter(x=>x).length + 1; }
                else if (board[i] === board.filter(x=>x).length) board[i] = null;
            } else if (state === 'PLAY') {
                if ((gameMode === 'PVP' || currentTurn === myOrder) && board[i] && !selectedIndices.has(i)) {
                    pendingChoice = i; displayBox.innerText = board[i];
                }
            }
            renderBoard(); checkButtons();
        }

        function confirmSelect() {
            if (pendingChoice !== null) {
                const num = board[pendingChoice]; pendingChoice = null; displayBox.innerText = '-';
                processMove(num, `ç©å®¶ ${currentTurn}`);
                currentTurn = (currentTurn % playerCount) + 1;
                checkNextTurn();
            }
        }

        function processMove(num, pName) {
    // ç¢ºä¿è™Ÿç¢¼æ˜¯æ•¸å­—å‹åˆ¥
    const targetNum = Number(num);
    
    // åˆ¤æ–·æ˜¯å¦ç‚ºç›®å‰ç©å®¶ï¼ˆä½ ï¼‰
    let displayName = pName;
    let playerRole = pName; // é¡å¤–å­˜ä¸€å€‹åŸå§‹æ¨™ç±¤ä¾› renderBoard ä½¿ç”¨
    if (currentTurn === myOrder) {
        displayName = "ä½ ";
    }

    // å°‡è³‡æ–™å­˜å…¥æ­·å²ç´€éŒ„ï¼Œå¢åŠ ä¸€å€‹ role å±¬æ€§ä¾†è¼”åŠ©æ¨™è¨˜é¡è‰²
    historyLog.push({ player: displayName, num: targetNum, role: playerRole });
    
    const idx = board.indexOf(targetNum); 
    if (idx !== -1) selectedIndices.add(idx);
    
    const cIdx = cpuBoard.indexOf(targetNum); 
    if (cIdx !== -1) cpuSelectedIndices.add(cIdx);
    
    renderBoard(); 
    updateGameLogic(); 
    updateHistoryUI();
}

        function checkNextTurn() {
    if (state !== 'PLAY') return;
    const turnEl = document.getElementById('turn-indicator');
    
    // å…ˆæ¸…é™¤èˆŠæœ‰çš„ç©å®¶é¡è‰²é¡åˆ¥
    turnEl.classList.remove('turn-player-1', 'turn-player-2', 'turn-player-3', 'turn-cpu');
    turnEl.className = 'turn-label active-turn';

    if (gameMode === 'PVE' && currentTurn !== myOrder) {
        // PVE é›»è…¦å›åˆ
        turnEl.innerText = 'ğŸ’» é›»è…¦æ€è€ƒä¸­...';
        turnEl.classList.add('turn-cpu');
        setTimeout(() => { 
            processMove(cpuSmartPick(), 'é›»è…¦'); 
            currentTurn = (currentTurn % playerCount) + 1; 
            checkNextTurn(); 
        }, 1000);
    } else {
        // çœŸäººå›åˆ (åŒ…å« PVE çš„ç©å®¶å›åˆ èˆ‡ PVP çš„æ‰€æœ‰å›åˆ)
        if (currentTurn === myOrder) {
            // ä¸è«– PVP æˆ– PVEï¼Œåªè¦è¼ªåˆ°ã€Œæˆ‘ã€å°±é¡¯ç¤ºé€™è¡Œ
            turnEl.innerText = 'ğŸ‘‰ æ›ä½ å–Šè™Ÿå›‰ï¼';
        } else {
            // PVP æ¨¡å¼ä¸‹ï¼Œè¼ªåˆ°å…¶ä»–çœŸäººç©å®¶
            turnEl.innerText = `ğŸ‘¤ ç©å®¶ ${currentTurn} å–Šè™Ÿ`;
        }
        // å¥—ç”¨å°æ‡‰çš„ç©å®¶é¡è‰²
        turnEl.classList.add(`turn-player-${currentTurn}`);
    }
}

        function updateGameLogic() {// æª¢æŸ¥å‹åˆ©æ¢ä»¶
    let pLines = 0, cLines = 0; 
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.strokeStyle = '#51cf66'; 
    ctx.lineWidth = 2;

    getWinPaths().forEach(path => {
        if (path.every(i => selectedIndices.has(i))) { pLines++; drawLine(path); }
        if (path.every(i => cpuSelectedIndices.has(i))) cLines++;
    });

    scoreEl.innerText = pLines;
    const goal = gridSize === 5 ? 5 : 7;

    if (pLines >= goal) {
        // åªæœ‰åœ¨ç©å®¶é”æˆç›®æ¨™æ™‚æ‰ç™¼å°„å½©èŠ±
        confetti({
            particleCount: 150,
            spread: 70,
            origin: { y: 0.6 },
            zIndex: 9999 // ç¢ºä¿å½©èŠ±åœ¨æœ€ä¸Šå±¤
        });
        showGameOver('BINGO!');
    } else if (gameMode === 'PVE' && cLines >= goal) {
        showGameOver('YOU LOSE!');
    }
}

       function renderBoard() {
    const cells = grid.querySelectorAll('.cell');
    cells.forEach((cell, i) => {
        cell.innerText = board[i] || '';
        cell.classList.toggle('pending', pendingChoice === i);
        cell.classList.remove('player-1', 'player-2', 'player-3', 'player-cpu');
        
        const log = historyLog.find(l => l.num === board[i]);
        if (log) {
            if (log.role === 'é›»è…¦') {
                cell.classList.add('player-cpu');
            } else {
                // å¾ role (ä¾‹å¦‚ "ç©å®¶ 1") æŠ“å–æ•¸å­—ï¼Œå°±ä¸æ€• displayName è®Šæˆ "ä½ "
                const playerNum = log.role.split(' ')[1];
                cell.classList.add(`player-${playerNum}`);
            }
        }
    });
}

function resetGame() {
    console.log("1. resetGame é–‹å§‹");

    state = 'FILL';
    selectedIndices.clear();
    cpuSelectedIndices.clear();
    historyLog = [];
    pendingChoice = null;

    // A. åˆ‡æ›é é¢é¡¯ç¤º
    const p1 = document.getElementById('page1');
    const p2 = document.getElementById('page2');
    if (p1) p1.classList.add('active');
    if (p2) p2.classList.remove('active');

    // B. åŸºç¤ UI å…§å®¹é‡è¨­
    if (displayBox) displayBox.innerText = '-';
    if (scoreEl) scoreEl.innerText = '0';
    if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
    document.getElementById('gameOver').style.display = 'none';

    const turnEl = document.getElementById('turn-indicator');
    if (turnEl) {
        turnEl.innerText = 'âœï¸ å¡«å¯«è™Ÿç¢¼ä¸­';
        turnEl.className = 'turn-label';
    }

    try {
        initGrid();
        checkButtons();
        updateStatusDisplay();

        // C. é—œéµä¿®æ­£ï¼šç›´æ¥åŸ·è¡Œ setPlayers ç¢ºä¿åˆå§‹ç‹€æ…‹ä¸‹ï¼ˆé è¨­2äººï¼‰ç¦ç”¨ç¬¬ä¸‰é †ä½
        // ç§»é™¤åŸæœ‰çš„ setTimeout ä»¥ç¢ºä¿åŒæ­¥åŸ·è¡Œ
        setPlayers(playerCount); 
        setMode(gameMode);
        
        // åŒæ­¥æ‰€æœ‰æŒ‰éˆ• UI
        updateBtnUI('p', playerCount);
        updateBtnUI('mode', gameMode);
        updateBtnUI('order', myOrder);
        updateBtnUI('size', gridSize);
        
    } catch (e) {
        console.error("åˆå§‹åŒ–éŒ¯èª¤:", e);
    }

    console.log("3. resetGame çµæŸ");
}


        // è¼”åŠ©åŠŸèƒ½
        function getWinPaths() {
            let paths = [];
            for (let i = 0; i < gridSize; i++) {
                let r = [], c = [];
                for (let j = 0; j < gridSize; j++) { r.push(i * gridSize + j); c.push(j * gridSize + i); }
                paths.push(r, c);
            }
            let d1 = [], d2 = [];
            for (let i = 0; i < gridSize; i++) { d1.push(i * gridSize + i); d2.push((i + 1) * gridSize - (i + 1)); }
            paths.push(d1, d2); return paths;
        }
        function drawLine(indices) {
            const cells = grid.querySelectorAll('.cell'), r = grid.getBoundingClientRect(), off = cells[0].offsetWidth / 2;
            ctx.beginPath();
            ctx.moveTo(cells[indices[0]].getBoundingClientRect().left - r.left + off, cells[indices[0]].getBoundingClientRect().top - r.top + off);
            ctx.lineTo(cells[indices[gridSize-1]].getBoundingClientRect().left - r.left + off, cells[indices[gridSize-1]].getBoundingClientRect().top - r.top + off);
            ctx.stroke();
        }
        function cpuSmartPick() {
            const paths = getWinPaths(), called = historyLog.map(l => l.num);
            let best = null, max = -1;
            for (let n = 1; n <= gridSize * gridSize; n++) {
                if (called.includes(n)) continue;
                let s = 0, idx = cpuBoard.indexOf(n);
                paths.forEach(p => { if (p.includes(idx)) s += Math.pow(10, p.filter(i => cpuSelectedIndices.has(i)).length); });
                if (s > max) { max = s; best = n; }
            }
            return best;
        }
        function startGame() { 
            state = 'PLAY'; 
            currentTurn = 1; 
            cpuBoard = Array.from({length: gridSize*gridSize}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
            document.getElementById('page1').classList.remove('active');
            document.getElementById('page2').classList.add('active');
            checkNextTurn();
        }
        function randomFill() { board = Array.from({length: gridSize*gridSize}, (_, i) => i + 1).sort(() => Math.random() - 0.5); renderBoard(); checkButtons(); }
        function clearAll() { board.fill(null); renderBoard(); checkButtons(); }
        function cancelSelect() { pendingChoice = null; displayBox.innerText = '-'; renderBoard(); }
        function checkButtons() { startBtn.disabled = board.includes(null); }
        function toggleInfo(s) { document.getElementById('infoBox').style.display = s ? 'block' : 'none'; }
        function toggleSettings(s) { document.getElementById('settingsBox').style.display = s ? 'block' : 'none'; }
        function toggleHistory(s) { document.getElementById('historyBox').style.display = s ? 'block' : 'none'; }
        function updateHistoryUI() { document.getElementById('logList').innerHTML = historyLog.map(h => `<div>[${h.player}] å–Šäº† ${h.num}</div>`).join('') || 'å°šæœªé–‹å§‹'; }
function setMode(v) {
    gameMode = v;
    const targetBtn = document.getElementById('mode' + v);
    if (targetBtn) updateBtnUI('mode', v);

    const p3Btn = document.getElementById('p3');
    if (p3Btn) {
        if (v === 'PVE') {
            p3Btn.disabled = true;
            if (playerCount === 3) setPlayers(2); 
        } else {
            p3Btn.disabled = false;
        }
    }
}

        function setSize(v) { gridSize = v; updateBtnUI('size', v); }
function setPlayers(v) {
    playerCount = v;
    // åªæœ‰åœ¨å…ƒç´ å­˜åœ¨æ™‚æ‰æ›´æ–° UI
    const targetBtn = document.getElementById('p' + v);
    if (targetBtn) updateBtnUI('p', v);

    const order3Btn = document.getElementById('order3');
    if (order3Btn) {
        if (v === 2) {
            order3Btn.disabled = true;
            if (myOrder === 3) {
                myOrder = 2; 
                if (document.getElementById('order2')) updateBtnUI('order', 2);
            }
        } else {
            order3Btn.disabled = false;
        }
    }
}


        function updateBtnUI(p, v) {
    // ä¿®æ­£ï¼šä½¿ç”¨æ›´ç²¾ç¢ºçš„é¸æ“‡å™¨ï¼Œç¢ºä¿åªé¸å–äººæ•¸ã€æ¨¡å¼ã€é †ä½æŒ‰éˆ•
    // åŸæœ¬çš„ [id^="${p}"] æœƒæŠ“åˆ° page1ï¼Œç¾åœ¨æˆ‘å€‘æ’é™¤æ‰å®ƒ
    const btns = document.querySelectorAll(`.btn-group button[id^="${p}"]`);
    btns.forEach(b => b.classList.remove('active'));
    
    const activeBtn = document.getElementById(`${p}${v}`);
    if (activeBtn) activeBtn.classList.add('active');
}
        function applySettings() { toggleSettings(false); resetGame(); }
        function showGameOver(t) { state = 'BINGO'; document.getElementById('winLossText').innerText = t; document.getElementById('gameOver').style.display = 'block'; }

    
    </script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</body>
</html>