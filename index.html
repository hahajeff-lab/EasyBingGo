<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥µç°¡æ·±è‰²è³“æœ - å°ˆæ¥­ç‰ˆ</title>
    <style>
        /* --- åŸºç¤è®Šæ•¸èˆ‡é‡ç½® --- */
:root {
    --bg-color: #121212;
    --card-bg: #1e1e1e;
    --text-color: #e0e0e0;
    --accent-red: rgba(255, 68, 68, 0.7);
    --accent-green: #51cf66;
    --accent-cancel: #c92a2a;
    --pending-color: #fcc419;
    --line-color: #51cf66;
    --border-color: #333;
}

body {
    background-color: var(--bg-color);
    color: var(--text-color);
    font-family: -apple-system, "Microsoft JhengHei", sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 0;
    padding: 30px 20px;
    min-height: 100vh; /* ç¢ºä¿ body è‡³å°‘è·Ÿè¢å¹•ä¸€æ¨£é«˜ */
    height: auto;      /* å…è¨± body æ ¹æ“šå…§å®¹è‡ªå‹•ä¼¸å±• */
    overflow-y: auto;  /* å¦‚æœå…§å®¹å¤ªé•·ï¼Œå…è¨±æ²å‹• */
}
/* --- å…¨åŸŸé»æ“Šå›é¥‹æ•ˆæœ --- */

/* 1. é‡å°æ‰€æœ‰æŒ‰éˆ•ä»¥åŠè³“æœæ ¼å­ (æ’é™¤è¢«ç¦ç”¨çš„ç‹€æ…‹) */
button:not(:disabled):active, 
.cell:not(:empty):active,
.info-icon:active,
.action-icon:active {
    transform: scale(0.95); /* è¼•å¾®ç¸®å° */
    filter: brightness(1.2); /* äº®åº¦æå‡ï¼Œåœ¨æ·±è‰²èƒŒæ™¯ä¸‹å¾ˆæœ‰è³ªæ„Ÿ */
    transition: transform 0.1s ease; /* å¿«é€ŸéŸ¿æ‡‰ */
}

/* 2. é‡å°ã€Œé‡å•Ÿã€èˆ‡ã€Œç´€éŒ„ã€é€™å…©å€‹ Icon æŒ‰éˆ•çš„ç‰¹æ®Šè™•ç† */
/* å› ç‚ºå®ƒå€‘æ˜¯æ­£æ–¹å½¢ï¼Œç¸®æ”¾æ•ˆæœæœƒæ¯”æ©«å‘æŒ‰éˆ•æ›´æ˜é¡¯ï¼Œæˆ‘å€‘å¾®èª¿ä¸€ä¸‹ */
.btn-restart-icon:active, 
.btn-history-icon:active {
    background-color: rgba(255, 255, 255, 0.1); /* é»æ“Šæ™‚èƒŒæ™¯ç¨å¾®è®Šç™½ */
    transform: scale(0.9); /* Icon é¡æŒ‰éˆ•ç¸®æ”¾å¯ä»¥ç¨å¾®å¤§ä¸€é» */
}

/* 3. é˜²æ­¢é»æ“Šæ™‚å‡ºç¾ç€è¦½å™¨é è¨­çš„è—è‰²å¤–æ¡† (å°¤å…¶åœ¨æ‰‹æ©Ÿä¸Š) */
button, .cell, .info-icon, .action-icon {
    -webkit-tap-highlight-color: transparent;
    outline: none;
}
#confirmRestartBox .btn-row button {
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    border: 1px solid var(--border-color);
}

/* --- é ‚éƒ¨å€åŸŸèˆ‡æŒ‡ç¤ºç‡ˆ --- */
.header-section {
    width: 100%;
    max-width: 200px; /* é€™è£¡è«‹æ ¹æ“šä½ ç›¤é¢çš„å¯¬åº¦è¨­å®šï¼Œæˆ–æ˜¯ 100% */
    margin: 0 auto;  /* ç½®ä¸­ */
    box-sizing: border-box;
    display: block;   /* ç¢ºä¿å®ƒä¸æ˜¯ inline-flex */
}
.status-container {
    width: 100% !important; /* å¼·åˆ¶å¯¬åº¦ */
    display: flex;
    flex-direction: column;
    align-items: stretch;    /* é—œéµï¼šå¼·åˆ¶å­å…ƒç´ æ’æ»¿å¯¬åº¦ */
    box-sizing: border-box;
}

.status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    white-space: nowrap;    /* é—œéµï¼šç¦æ­¢æ–‡å­—æ›è¡Œ */
    box-sizing: border-box;
    margin-bottom: 8px;
}

/* ç‚ºäº†è®“ã€Œä¸­é–“ã€çš„äººæ•¸çœŸçš„åœ¨æ­£ä¸­å¤®ï¼Œ
   æˆ‘å€‘å¯ä»¥çµ¦é€™ä¸‰å€‹ span è¨­å®šç›¸ç­‰å¯¬åº¦çš„åŸºç¤ï¼ˆé¸é…ï¼‰ */
.status-bar .mini-tag {
    flex: 1; /* è®“ä¸‰å€‹æ¨™ç±¤å¹³åˆ†ç©ºé–“ */
}

.status-bar .mini-tag:nth-child(1) { text-align: left; }
.status-bar .mini-tag:nth-child(2) { text-align: center; }
.status-bar .mini-tag:nth-child(3) { text-align: right; }

.score-bar {
    font-size: 1.5rem;
    color: var(--line-color);
    font-weight: bold;
    width: 100%;
    text-align: center;
    display: block; /* ç¢ºä¿å®ƒæ˜¯æ•´è¡Œä½”æ“š */
}
.mini-tag {
    font-size: 10px;
    color: #8a8a8a;
    letter-spacing: 1px;
    background: rgba(255,255,255,0.03);
    padding: 2px 8px;
    border-radius: 4px;
}

.main-status-area {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 60px;
}

.turn-label {
    display: block; /* 1. æ”¹æˆ blockï¼Œå› ç‚ºå®ƒç¾åœ¨æ˜¯ç¨ç«‹çš„ä¸€æ’ */
    padding: 8px 24px;
    width: 100%;
    box-sizing: border-box; /* 2. é—œéµä¿®æ­£ï¼šè®“å¯¬åº¦åŒ…å« padding */
    border-radius: 25px;
    font-size: 0.9rem;
    font-weight: bold;
    text-align: center;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.05);
    color: var(--line-color);
    border: 1px solid transparent;
    margin-top: 0px;
}

.active-turn { animation: pulse-border 1.5s infinite ease-in-out; }
@keyframes pulse-border {
    0% { transform: scale(1); }
    50% { transform: scale(1.08); }
    100% { transform: scale(1); }
}

.sub-info-row { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }

/* ç©å®¶é¡è‰²æ¨£å¼ */
.turn-player-1 { color: #ff4444; background: rgba(255, 68, 68, 0.1); border-color: rgba(255, 68, 68, 0.3); }
.turn-player-2 { color: #4dabf7; background: rgba(77, 171, 247, 0.1); border-color: rgba(77, 171, 247, 0.3); }
.turn-player-3 { color: rgb(239, 255, 114); background: rgba(239, 255, 114, 0.1); border-color: rgba(239, 255, 114, 0.3); }
.turn-cpu { color: rgb(146, 88, 238); background: rgba(146, 88, 238, 0.1); border-color:rgba(146, 88, 238, 0.3); }

/* --- éŠæˆ²ç›¤é¢èˆ‡æ ¼å­ --- */
.grid-container {
    position: relative;
    display: grid;
    gap: 6px;
    padding: 10px;
    background: #252525;
    border-radius: 8px;
    margin-top: 10px;/*æ§åˆ¶ä¸Šé‚Šè·*/
    margin-bottom: 10px;/*æ§åˆ¶ä¸‹é‚Šè·*/
}

.cell {
    background: var(--card-bg);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: relative;
    font-weight: 500;
    transition: all 0.2s;
    overflow: hidden;
}
/* é é¸æ¡†æ¨£å¼ï¼šåˆ©ç”¨ box-shadow æˆ– borderï¼Œä¸å½±éŸ¿ä½ˆå±€ */
.cell.pending-select {
    /* æ”¹ç”¨ border å¯¦ç¾è™›ç·šï¼Œ1.5px æˆ– 2px æ•ˆæœæœ€å¥½ */
    border: 2px dashed #ffd900 !important; 
    
    /* é—œéµï¼šç¢ºä¿ border ä¸æœƒæ’å¤§æ ¼å­å¯¬é«˜ */
    box-sizing: border-box; 
    
    /* èƒŒæ™¯ç¨å¾®èª¿æ·¡ä¸€é»ï¼Œè®“è™›ç·šæ›´æ˜é¡¯ */
    background-color: rgba(255, 217, 0, 0.15) !important;
    
    position: relative;
    z-index: 2;
}

/* å¦‚æœä½ çš„ .cell é è¨­æ²’æœ‰è¨­å®š box-sizingï¼Œå»ºè­°ä¹ŸåŠ ä¸Šé€™è¡Œ */
.cell {
    box-sizing: border-box;
}
.grid-container[style*="grid-template-columns: repeat(7"] .cell {
    font-size: 0.9rem; /* å°ˆé–€é‡å° 7x7 çš„å­—é«”å¤§å° */
}
/* ç©å®¶åœ“åœˆæ¨™è¨˜ */
.cell::after {
    content: '';
    position: absolute;
    width: 65%;
    height: 65%;
    border-radius: 50%;
    z-index: 1;
    display: none;
}
.cell.player-1::after { display: block; background: rgba(255, 68, 68, 0.7); }
.cell.player-2::after { display: block; background: rgba(77, 171, 247, 0.7); }
.cell.player-3::after { display: block; background: rgba(239, 255, 114, 0.7); }
.cell.player-cpu::after { display: block; background: rgba(146, 88, 238, 0.4); }

.cell.pending { outline: 2px dashed var(--pending-color); outline-offset: -4px; color: var(--pending-color); }
#lineCanvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 2; }

/* --- æ§åˆ¶æŒ‰éˆ•èˆ‡é é¢ --- */
.controls {
    width: 100%;
    max-width: 280px;
    min-height: 50px; /* çµ¦äºˆæœ€å°é«˜åº¦ */
    margin-top: 0px;/*æ§åˆ¶ä¸Šç·¨åŠ‡*/
    overflow: visible ; /* é˜²æ­¢å…§å®¹è¢«åˆ‡æ‰ */
}
.page {
    display: none;
    width: 100%;
}
.page.active {
    display: flex ;   /* ä½¿ç”¨ flex æˆ– block ç¢ºä¿é¡¯ç¤º */
    flex-direction: column;
    align-items: center;
    gap: 10px;
    visibility: visible ;
    opacity: 1 ;
}
.page.active * {
    visibility: visible;
}
.btn-row {
    display: flex;
    justify-content: space-between; /* è®“å…©å€‹æŒ‰éˆ•åˆ†å±…å·¦å³å…©ç«¯ï¼Œä¸­é–“ç©ºå‡ºè·é›¢ */
    gap: 20px;
    margin-top: 15px;
    align-items: center;
}

button {
    background: rgba(255, 255, 255, 0.05); color: var(--text-color);
    border: 1px solid #444; border-radius: 6px; padding: 10px 15px;
    cursor: pointer; font-size: 14px; transition: all 0.2s;box-sizing: border-box; /* æ–°å¢é€™è¡Œï¼Œç¢ºä¿é‚Šæ¡†ä¸æœƒæ’å¤§é«˜åº¦ */
}
button:disabled { opacity: 0.2; cursor: not-allowed; }
button.active { background: var(--line-color); color: #121212; border-color: var(--line-color); font-weight: bold; box-shadow: 0 0 10px rgba(81, 207, 102, 0.3); }

.btn-confirm { border-color: var(--accent-green); color: var(--accent-green); }
.btn-cancel { border-color: var(--accent-cancel); color: var(--accent-cancel); }
.btn-start { border-color: var(--line-color); color: var(--line-color); font-weight: bold; }
.btn-restart-icon, .btn-history-icon {
    flex: 0 0 50px;      /* å›ºå®šå¯¬åº¦ï¼Œä¸éš¨çˆ¶å®¹å™¨æ‹‰ä¼¸ */
    height: 50px;       /* ç¢ºä¿æ˜¯æ­£æ–¹å½¢ */
    border-radius: 12px;
    border: 1px solid var(--border-color);
    background: var(--card-bg);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}
.btn-restart-icon {
    border-color: var(--pending-color);
    color: var(--pending-color);
}
.icon-refresh {
    font-size: 1.5rem;
    font-weight: bold;
    /* è®“å®ƒçœ‹èµ·ä¾†æ›´æœ‰æ—‹è½‰æ„Ÿ */
    display: inline-block;
    transform: rotate(45deg); 
}

/* ç´€éŒ„æŒ‰éˆ•é¡è‰² */
.btn-history-icon {
    color: var(--text-color);
}

.icon-scroll {
    font-size: 1.4rem;
}

.confirm-row { 
    display: flex; align-items: center; justify-content: space-between; 
    background: #1a1a1a; padding: 10px 15px; border-radius: 8px; border: 1px solid #333;gap : 20px;
}
.display-box { font-size: 1.4rem; font-weight: bold; color: var(--pending-color); min-width: 40px; text-align: center; }

/* --- å½ˆçª—ã€è¨­å®šèˆ‡ç´€éŒ„ (åŒ…å«ç¸®å°å­—é«”) --- */
.info-overlay, .overlay {
    display: none; position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); 
    background: rgba(20, 20, 20, 0.98); padding: 25px; border: 1px solid var(--line-color); 
    border-radius: 12px; z-index: 200; width: 260px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.8);
}

.settings-row { margin-bottom: 12px; text-align: left; }
.settings-label { display: block; font-size: 14px; color: #888; margin-bottom: 4px; } 
.btn-group { display: flex; gap: 4px; }
.btn-group button { flex: 1; padding: 5px; font-size: 14px; } /* ç¸®å°è¨­å®šæŒ‰éˆ•å­—é«” */

.info-title { font-weight: bold; color: var(--line-color); margin-bottom: 15px; display: block; font-size: 16px; }
.info-content { font-size: 0.85rem; color: #ccc; line-height: 1.6; margin-bottom: 20px; }

/* å°æˆ°ç´€éŒ„åˆ—è¡¨ */
#logList { 
    margin: 15px 0; max-height: 150px; overflow-y: auto; font-size: 0.8rem; text-align: left; 
    padding-right: 5px;
}
#logList::-webkit-scrollbar { width: 4px; }
#logList::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }

/* è³“æœç‰¹æ•ˆæ–‡å­— */
.bingo-text { font-size: 2.2rem; font-weight: bold; color: var(--line-color); display: block; margin-bottom: 10px; animation: blink 1s infinite; text-shadow: 0 0 15px var(--line-color); }
@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

/* --- åœ–ç¤ºèˆ‡æ„Ÿæ‡‰å€ --- */
.info-icon { 
    position: absolute; top: 20px; left: 20px; width: 22px; height: 22px; 
    border: 1px solid #c6c6c6; border-radius: 50%; display: flex; align-items: center; 
    justify-content: center; font-size: 14px; color: #c6c6c6; cursor: pointer;
}

.top-actions { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; }
.action-icon { 
    font-size: 22px; color: #c6c6c6; cursor: pointer; 
    padding: 15px; margin: -15px; /* æ“´å¤§é»æ“Šæ„Ÿæ‡‰å€ */
}



.btn-cpu-icon {
    flex: 0 0 50px;
    height: 50px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    background: var(--card-bg);
    cursor: pointer;
    font-size: 1.2rem;
}

/* ç¬¬äºŒéšæ®µï¼šé›»è…¦ç›¤é¢ Grid ä½ˆå±€èˆ‡æ­£æ–¹å½¢è¨­å®š */
/* --- é›»è…¦ç›¤é¢å°ˆå±¬éš”é›¢æ¨£å¼ (æ–°æ–¹æ¡ˆ) --- */

/* é®ç½©å±¤ï¼šç¢ºä¿å…¨è¢å¹•è¦†è“‹ä¸¦å‚ç›´æ°´å¹³ç½®ä¸­ */
.cpu-modal-overlay {
    display: none; /* ç”± JS åˆ‡æ›ç‚º flex */
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.85);
    z-index: 3000;
    justify-content: center;
    align-items: center;
}

/* å…§å®¹ä¸»é«”ï¼šç§»é™¤æ‰€æœ‰ç¹¼æ‰¿çš„å®šä½ï¼Œç¢ºä¿åœ¨ Flex å®¹å™¨ä¸­ç½®ä¸­ */
.cpu-modal-content {
    background-color: var(--card-bg);
    padding: 20px;
    border-radius: 15px;
    border: 1px solid var(--border-color);
    width: 85%;
    max-width: 350px;
    box-sizing: border-box;
    text-align: center;
    /* é€™è£¡ä¸éœ€è¦ position: absolute æˆ– top/leftï¼Œç”±çˆ¶å±¤ Flex æ§åˆ¶ */
}

/* é›»è…¦ç›¤é¢å®¹å™¨ï¼šåƒè€ƒæ¸¬è©¦æˆåŠŸçš„ grid-container */
#cpuGridPreview {
    display: grid;
    /* æ¬„ä½æ•¸é‡ repeat(${gridSize}, 1fr) å°‡ç”± JS å‹•æ…‹æ³¨å…¥ */
    gap: 8px; 
    width: 100%; 
    max-width: 320px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ï¼Œé¿å…åœ¨å¤§è¢å¹•éåº¦æ‹‰ä¼¸ */
    margin: 15px auto;
}

/* æ ¼å­æ¨£å¼ï¼šåƒè€ƒæ¸¬è©¦æˆåŠŸçš„ grid-item ä¸¦ç¹¼æ‰¿åŸæœ¬çš„ cell æ¨£å¼ */
#cpuGridPreview .cell {
    position: relative;
    width: 100%;
    aspect-ratio: 1 / 1; /* å¼·åˆ¶å¯¬é«˜æ¯”ç‚º 1:1 æ­£æ–¹å½¢ */
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    box-sizing: border-box;
}

/* ç¢ºä¿é›»è…¦ç´«è‰²åœ“é»åœ¨æ­£æ–¹å½¢æ ¼å­å…§æ­£ç¢ºé¡¯ç¤º */
#cpuGridPreview .cell.player-cpu::after {
    content: '';
    position: absolute;
    width: 70%;
    height: 70%;
    background-color: rgba(146, 88, 238, 0.4); /* é›»è…¦å°ˆå±¬ç´« */
    border-radius: 50%;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: block; /* ç¢ºä¿é¡¯ç¤º */
}


/* --- é å°¾ --- */
.footer-info { width: 100%; text-align: center; font-size: 10px; color: #444; margin-top: 20px; padding-bottom: 20px; letter-spacing: 0.5px; }

    </style>
</head>

<body>
<div class="header-section">
    <div class="info-icon" onclick="toggleInfo(true)">i</div>

    <div class="status-container">
    <div class="score-bar">
        SCORE: <span id="score">0</span>
    </div>

    <div class="status-bar">
        <span id="mode-display" class="mini-tag">PVP</span>
        <span id="players-display" class="mini-tag">2äºº</span>
        <span id="target-display" class="mini-tag">ç›®æ¨™: 5</span> 
    </div>

    <div id="turn-indicator" class="turn-label">âœï¸ å¡«å¯«è™Ÿç¢¼ä¸­</div>
</div>

    <div class="top-actions">
        <div class="action-icon" onclick="toggleSettings(true)">â˜°</div>
    </div>
</div>

    <div class="grid-container" id="grid">
        <canvas id="lineCanvas"></canvas>
    </div>

    <div class="controls">
        <div id="page1" class="page active">
            <div class="btn-row">
                <button onclick="clearAll()" style="flex:1">å…¨éƒ¨æ¸…é™¤</button>
                <button onclick="randomFill()" style="flex:1">éš¨æ©Ÿå¡«å¯«</button>
            </div>
            <div class="btn-row">
                <button id="startBtn" class="btn-start" onclick="startGame()" disabled style="width: 100%;">é–‹å§‹éŠæˆ²</button>
            </div>
        </div>

        <div id="page2" class="page">
            <div class="confirm-row">
                <button class="btn-cancel" onclick="cancelSelect()">X</button>
                <div class="display-box" id="displayBox">-</div>
                <button class="btn-confirm" onclick="confirmSelect()">O</button>
            </div>
            <div class="btn-row">
    <button id="restartBtn" class="btn-restart-icon" onclick="resetGame()" title="é‡å•ŸéŠæˆ²">
        <span class="icon-refresh">â†»</span>
    </button>
    
    <button id="viewCpuBtn" class="btn-cpu-icon" onclick="toggleCpuBoard(true)" title="æŸ¥çœ‹é›»è…¦ç›¤é¢" disabled>
        <span>ğŸ¤–</span>
    </button>
    
    <button class="btn-history-icon" onclick="toggleHistory(true)" title="å°æˆ°ç´€éŒ„">
        <span class="icon-scroll">ğŸ“œ</span>
    </button>
</div>
        </div>
    </div>

    <div id="infoBox" class="info-overlay">
        <span style="color:var(--line-color); font-weight:bold;">æ“ä½œèªªæ˜</span><br><br>
        <div style="text-align:left; font-size:0.9rem; line-height:1.6; color:#ccc;">
            <b>å¡«å¯«æ¨¡å¼:</b> é»æ“Šæ ¼å­å¡«è™Ÿï¼Œå¡«æ»¿å¾ŒæŒ‰é–‹å§‹ã€‚<br>
            <b>éŠæˆ²æ¨¡å¼:</b> é»æ“Šæ•¸å­—å¾ŒæŒ‰ O ç¢ºèªã€‚
        </div><br>
        <button onclick="toggleInfo(false)" style="width: 100%;">æˆ‘çŸ¥é“äº†</button>
    </div>

    <div id="settingsBox" class="info-overlay">
        <span style="color:var(--line-color); font-weight:bold;">éŠæˆ²è¨­å®š</span><br><br>
        <div class="settings-row">
            <span class="settings-label">æ¨¡å¼</span>
            <div class="btn-group">
                <button id="modePVP" class="active" onclick="setMode('PVP')">çœŸäººå°æˆ°</button>
                <button id="modePVE" onclick="setMode('PVE')">é›»è…¦é™ªç©</button>
            </div>
        </div>
        <div class="settings-row">
            <span class="settings-label">äººæ•¸</span>
            <div class="btn-group">
                <button id="p2" class="active" onclick="setPlayers(2)">2äºº</button>
                <button id="p3" onclick="setPlayers(3)">3äºº</button>
            </div>
        </div>

        <div class="settings-row">
        <span class="settings-label">ä½ çš„é †ä½ (ç¬¬å¹¾å€‹å–Š)</span>
        <div class="btn-group">
            <button id="order1" class="active" onclick="setOrder(1)">1</button>
            <button id="order2" onclick="setOrder(2)">2</button>
            <button id="order3" onclick="setOrder(3)">3</button>
        </div>
    </div>

        
        <div class="settings-row">
            <span class="settings-label">æ ¼å­å¤§å°</span>
            <div class="btn-group">
                <button id="size5" class="active" onclick="setSize(5)">5X5</button>
                <button id="size7" onclick="setSize(7)">7X7</button>
            </div>
        </div>

        <div class="settings-row" id="winConditionRow">
    <span class="settings-label">å‹åˆ©æ¢ä»¶</span>
    <div class="btn-group">
        <button id="win5" class="active" onclick="setWinLines(5)">5ç·š</button>
        <button id="win7" onclick="setWinLines(7)">7ç·š</button>
    </div>
</div>
        <div class="btn-row"><button onclick="applySettings()" style="width: 100%; border-color:var(--line-color);">å¥—ç”¨ä¸¦é‡ç½®</button></div>
    </div>

    <div id="historyBox" class="info-overlay">
        <span style="color:var(--line-color); font-weight:bold;">å°æˆ°ç´€éŒ„</span>
        <br><span style ="color:darkkhaki; font-size:0.8rem;">ï¼ˆæœ€æ–°ç´€éŒ„åœ¨æœ€ä¸‹æ–¹ï¼‰</span><br>
        <div id="logList" style="margin:15px 0; max-height:150px; overflow-y:auto; font-size:0.8rem; text-align:left;"></div>
        <button onclick="toggleHistory(false)" style="width: 100%;">é—œé–‰</button>
    </div>

<div id="cpuBoardOverlay" class="cpu-modal-overlay" onclick="toggleCpuBoard(false)">
    <div id="cpuBoardBox" class="cpu-modal-content" onclick="event.stopPropagation()">
        <span style="color:var(--pending-color); font-weight:bold;">é›»è…¦çš„ç›¤é¢</span><br><br>
        
        <div style="position: relative; display: inline-block; width: 100%;">
            <div id="cpuGridPreview"></div>
            <canvas id="cpuLineCanvas" style="position: absolute; top: 0; left: 0; pointer-events: none; z-index: 5;"></canvas>
        </div>
        
        <div id="cpuScore" style="margin: 10px 0; font-size: 0.9rem; color: #888;"></div>
        
        <button onclick="toggleCpuBoard(false)" style="width: 100%; margin-top: 10px;">
            é—œé–‰
        </button>
    </div>
</div>

    <div id="confirmRestartBox" class="info-overlay">
    <span style="color:var(--pending-color); font-weight:bold; font-size:1.1rem;">ç¢ºå®šè¦é‡æ–°é–‹å§‹å—ï¼Ÿ</span><br><br>
    <div style="color:#ccc; font-size:0.9rem; margin-bottom: 20px;">
        ç›®å‰çš„éŠæˆ²é€²åº¦å°‡æœƒéºå¤±ã€‚
    </div>
    <div class="btn-row">
        <button onclick="toggleConfirmRestart(false)" style="flex:1; background:transparent;">å–æ¶ˆ</button>
        <button onclick="executeReset()" style="flex:1; border-color:var(--pending-color); color:var(--pending-color);">ç¢ºå®š</button>
    </div>
</div>

    <div id="gameOver" class="overlay" onclick="this.style.display='none'">
        <span class="bingo-text" id="winLossText">BINGO!</span>
        <div style="font-size:0.8rem; color:#c9c9c9;">éŠæˆ²çµæŸï¼Œè«‹é‡å•ŸéŠæˆ²æˆ–æŸ¥é–±å°æˆ°ç´€éŒ„ã€‚<br>æœ¬è¦–çª—é»æ“Šå¾Œé—œé–‰</div>
    </div>

    <footer class="footer-info">
        <div>&copy; 2026 Jan Hahajeff. All Rights Reserved.</div>
        <div style="opacity: 0.5;">Powered by Gemini AI | Version 2.0</div>
    </footer>

    <script>
// åŸºç¤éŠæˆ²ç‹€æ…‹
    let state = 'FILL'; 
    let gridSize = 5; 
    let gameMode = 'PVP'; 
    let playerCount = 2; 
    let myOrder = 1;      // <--- è£œå›é€™è¡Œï¼Œé è¨­ä½ æ˜¯ç¬¬ 1 é †ä½
    let currentTurn = 1; 
    let targetWinLines = 5; // é è¨­æ”¹ç‚º 5 æ¢ç·š

    // ç›¤é¢è³‡æ–™
    let board = []; 
    let selectedIndices = new Set(); 
    let cpuBoard = []; 
    let cpuSelectedIndices = new Set(); 
    let historyLog = []; 
    let pendingChoice = null;
    // ç¶²é è¼‰å…¥å®Œæˆæ™‚åˆå§‹åŒ–
    window.onload = function() {
    resetGame();
    };

        const grid = document.getElementById('grid'), scoreEl = document.getElementById('score'), startBtn = document.getElementById('startBtn'), restartBtn = document.getElementById('restartBtn'), displayBox = document.getElementById('displayBox'), canvas = document.getElementById('lineCanvas'), ctx = canvas.getContext('2d');

        function initGrid() {
            grid.querySelectorAll('.cell').forEach(el => el.remove());
            const total = gridSize * gridSize; board = Array(total).fill(null);
            const cellSize = gridSize === 5 ? 52 : 38;
            grid.style.gridTemplateColumns = `repeat(${gridSize}, ${cellSize}px)`;
            const side = (cellSize * gridSize) + (6 * (gridSize - 1)) + 20;
            canvas.width = side; canvas.height = side;

            for (let i = 0; i < total; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.style.width = cell.style.height = cellSize + 'px';
                cell.style.fontSize = gridSize === 5 ? '20px' : '14px';
                cell.onclick = () => handleCellClick(i);
                grid.appendChild(cell);
            }
        }

        function setWinLines(lines) {
        targetWinLines = lines;
        // æ›´æ–° UI æŒ‰éˆ•ç‹€æ…‹
        document.querySelectorAll('#winConditionRow button').forEach(btn => {
        btn.classList.remove('active');
            });
        const activeBtn = document.getElementById('win' + lines);
        if (activeBtn) activeBtn.classList.add('active');
        }

        function updateStatusDisplay() {
            document.getElementById('mode-display').innerText = gameMode;
            document.getElementById('players-display').innerText = playerCount + 'äºº';
            // æ–°å¢ï¼šæ›´æ–°ç›®æ¨™é€£ç·šæ•¸
        const targetEl = document.getElementById('target-display');
        if (targetEl) {
            targetEl.innerText = 'ç›®æ¨™: ' + targetWinLines;
        }
    
        // ç¢ºä¿é‡ç½®æ™‚åˆ†æ•¸æ­¸é›¶
        scoreEl.innerText = '0';
        }

        function setOrder(order) {
    myOrder = order; // æ›´æ–°å…¨åŸŸè®Šæ•¸

    // æ›´æ–° UI æ¨£å¼
    document.getElementById('order1').classList.remove('active');
    document.getElementById('order2').classList.remove('active');
    document.getElementById('order3').classList.remove('active');
    document.getElementById('order' + order).classList.add('active');

    // å¦‚æœéœ€è¦é¡¯ç¤ºåœ¨ç‹€æ…‹åˆ—ï¼Œå¯ä»¥å‘¼å« updateStatusDisplay()
    updateStatusDisplay();
}

        function handleCellClick(i) {
    if (state === 'FILL') {
        // å¡«å¯«æ¨¡å¼ç¶­æŒåŸé‚è¼¯ï¼Œå› ç‚ºæ¶‰åŠæ•¸å­—é †åºè¨ˆç®—ï¼Œéœ€è¦ renderBoard
        if (board[i] === null) { 
            if (board.filter(x => x).length < gridSize * gridSize) 
                board[i] = board.filter(x => x).length + 1; 
        } else if (board[i] === board.filter(x => x).length) {
            board[i] = null;
        }
        renderBoard(); 
    } else if (state === 'PLAY') {
        // æª¢æŸ¥æ˜¯å¦è¼ªåˆ°è©²ç©å®¶ï¼Œä¸”è©²æ ¼æœ‰æ•¸å­—ã€æœªè¢«é¸é
        if ((gameMode === 'PVP' || currentTurn === myOrder) && board[i] && !selectedIndices.has(i)) {
            pendingChoice = i; 
            displayBox.innerText = board[i];

            // --- æ•ˆèƒ½å„ªåŒ–ï¼šæ‰‹å‹•åˆ‡æ› CSSï¼Œä¸è§¸ç™¼ renderBoard ---
            // 1. ä½¿ç”¨ querySelectorAll('.cell') ç¢ºä¿ç´¢å¼•ç²¾æº–ï¼Œä¸è¢« canvas å½±éŸ¿
            const allCells = grid.querySelectorAll('.cell');
            
            // 2. ç§»é™¤æ‰€æœ‰æ ¼å­ä¸Šçš„é é¸æ¨£å¼
            allCells.forEach(cell => cell.classList.remove('pending-select'));
            
            // 3. æ ¹æ“šç´¢å¼• i ç›´æ¥æŒ‡æ´¾æ¨£å¼çµ¦æ­£ç¢ºçš„ DOM å…ƒç´ 
            if (allCells[i]) {
                allCells[i].classList.add('pending-select');
            }
        }
    }
    checkButtons();
}

        function confirmSelect() {
    if (pendingChoice !== null) {
        const num = board[pendingChoice]; 
        
        // 1. é‡ç½®é é¸ç‹€æ…‹èˆ‡é¡¯ç¤º
        pendingChoice = null; 
        displayBox.innerText = '-';

        // 2. åŸ·è¡Œé¸è™Ÿé‚è¼¯ï¼ˆé€™é€šå¸¸æœƒåŒ…å«å°‡æ•¸å­—åŠ å…¥ selectedIndicesï¼‰
        processMove(num, `ç©å®¶ ${currentTurn}`);

        // 3. åˆ‡æ›ç©å®¶é †ä½
        currentTurn = (currentTurn % playerCount) + 1;

        // 4. é‡é»ï¼šå‘¼å« renderBoard() ç¢ºä¿é»ƒæ¡†æ¶ˆå¤±ä¸¦æ›´æ–°ç›¤é¢è¦–è¦º
        // å¦‚æœä½ çš„ processMove è£¡é¢å·²ç¶“æœ‰å‘¼å« renderBoard()ï¼Œé€™è¡Œå¯ä»¥çœç•¥
        renderBoard(); 

        // 5. æª¢æŸ¥ä¸‹ä¸€è¼ªç‹€æ…‹ï¼ˆå¦‚é›»è…¦å‡ºç‰Œæˆ–æª¢æŸ¥è¼¸è´ï¼‰
        checkNextTurn();
        
        // 6. æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        checkButtons();
    }
}

        function processMove(num, pName) {
    // ç¢ºä¿è™Ÿç¢¼æ˜¯æ•¸å­—å‹åˆ¥
    const targetNum = Number(num);
    
    // åˆ¤æ–·æ˜¯å¦ç‚ºç›®å‰ç©å®¶ï¼ˆä½ ï¼‰
    let displayName = pName;
    let playerRole = pName; // é¡å¤–å­˜ä¸€å€‹åŸå§‹æ¨™ç±¤ä¾› renderBoard ä½¿ç”¨
    if (currentTurn === myOrder) {
        displayName = "ä½ ";
    }

    // å°‡è³‡æ–™å­˜å…¥æ­·å²ç´€éŒ„ï¼Œå¢åŠ ä¸€å€‹ role å±¬æ€§ä¾†è¼”åŠ©æ¨™è¨˜é¡è‰²
    historyLog.push({ player: displayName, num: targetNum, role: playerRole });
    
    const idx = board.indexOf(targetNum); 
    if (idx !== -1) selectedIndices.add(idx);
    
    const cIdx = cpuBoard.indexOf(targetNum); 
    if (cIdx !== -1) cpuSelectedIndices.add(cIdx);
    
    renderBoard(); 
    updateGameLogic(); 
    updateHistoryUI();
}

        function checkNextTurn() {
    if (state !== 'PLAY') return;
    const turnEl = document.getElementById('turn-indicator');
    
    // å…ˆæ¸…é™¤èˆŠæœ‰çš„ç©å®¶é¡è‰²é¡åˆ¥
    turnEl.classList.remove('turn-player-1', 'turn-player-2', 'turn-player-3', 'turn-cpu');
    turnEl.className = 'turn-label active-turn';

    if (gameMode === 'PVE' && currentTurn !== myOrder) {
        // PVE é›»è…¦å›åˆ
        turnEl.innerText = 'ğŸ’» é›»è…¦æ€è€ƒä¸­...';
        turnEl.classList.add('turn-cpu');
        setTimeout(() => { 
            processMove(cpuSmartPick(), 'é›»è…¦'); 
            currentTurn = (currentTurn % playerCount) + 1; 
            checkNextTurn(); 
        }, 1000);
    } else {
        // çœŸäººå›åˆ (åŒ…å« PVE çš„ç©å®¶å›åˆ èˆ‡ PVP çš„æ‰€æœ‰å›åˆ)
        if (currentTurn === myOrder) {
            // ä¸è«– PVP æˆ– PVEï¼Œåªè¦è¼ªåˆ°ã€Œæˆ‘ã€å°±é¡¯ç¤ºé€™è¡Œ
            turnEl.innerText = 'ğŸ‘‰ æ›ä½ å–Šè™Ÿå›‰ï¼';
        } else {
            // PVP æ¨¡å¼ä¸‹ï¼Œè¼ªåˆ°å…¶ä»–çœŸäººç©å®¶
            turnEl.innerText = `ğŸ‘¤ ç©å®¶ ${currentTurn} å–Šè™Ÿ`;
        }
        // å¥—ç”¨å°æ‡‰çš„ç©å®¶é¡è‰²
        turnEl.classList.add(`turn-player-${currentTurn}`);
    }
}

        function updateGameLogic() {
    // æª¢æŸ¥å‹åˆ©æ¢ä»¶
    let pLines = 0, cLines = 0; 
    
    getWinPaths().forEach(path => {
        // ç©å®¶é€£ç·šåˆ¤å®š
        if (path.every(i => selectedIndices.has(i))) { 
            pLines++; 
            // é‡é» 2ï¼šç§»é™¤åŸæœ¬çš„ drawLine(path); 
        }
        // é›»è…¦é€£ç·šåˆ¤å®š
        if (path.every(i => cpuSelectedIndices.has(i))) {
            cLines++;
        }
    });

    renderBingoLines('grid', 'lineCanvas', selectedIndices);

    // --- å¢åŠ PVEå¹³æ‰‹åˆ¤æ–· ---
    scoreEl.innerText = pLines;//scoreEl.innerText = `${pLines} / ${targetWinLines}`

    // 1. å„ªå…ˆåˆ¤æ–·åŒæ™‚è³“æœ (å¹³æ‰‹)
    if (pLines >= targetWinLines && (gameMode === 'PVE' && cLines >= targetWinLines)) {
        // è§£é–æŒ‰éˆ•
        const viewBtn = document.getElementById('viewCpuBtn');
        if (viewBtn) viewBtn.disabled = false;
        
        // æ…¶ç¥ç‰¹æ•ˆ (å¹³æ‰‹ä¹Ÿå€¼å¾—æ…¶ç¥ä¸€ä¸‹)
        confetti({ particleCount: 100, spread: 50, origin: { y: 0.6 }, zIndex: 9999 });
        
        showGameOver('DRAW! (åŒæ™‚è³“æœ)');

    // 2. åˆ¤æ–·ç©å®¶ç¨è‡ªç²å‹
    } else if (pLines >= targetWinLines) {
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, zIndex: 9999 });
        
        if (gameMode === 'PVE') {
            const viewBtn = document.getElementById('viewCpuBtn');
            if (viewBtn) viewBtn.disabled = false;
        }
        showGameOver('BINGO!');
        
    // 3. åˆ¤æ–·é›»è…¦ç¨è‡ªç²å‹
    } else if (gameMode === 'PVE' && cLines >= targetWinLines) {
        const viewBtn = document.getElementById('viewCpuBtn');
        if (viewBtn) viewBtn.disabled = false;
        showGameOver('YOU LOSE!');
    }
}

      function renderBoard() {
    // 1. æŠ“å–æ‰€æœ‰æ ¼å­
    const cells = grid.querySelectorAll('.cell');
    
    // 2. é–‹å§‹è·‘æ¯ä¸€æ ¼çš„ç‹€æ…‹æ›´æ–°
    cells.forEach((cell, i) => {
        // è¨­å®šè™Ÿç¢¼ (å¦‚æœæ²’æœ‰è™Ÿç¢¼å°±é¡¯ç¤ºç©ºç™½)
        cell.innerText = board[i] || '';
        
        // --- æ ¸å¿ƒä¿®æ­£ï¼šåŒæ­¥æ¸…é™¤ã€Œæ‰‹å‹•é»æ“Šã€èˆ‡ã€Œé‚è¼¯åˆ¤æ–·ã€çš„é é¸æ¨£å¼ ---
        // é€™ä¸€è¡Œæœƒæ ¹æ“š pendingChoice æ˜¯å¦ç­‰æ–¼ç•¶å‰æ ¼å­ï¼Œè‡ªå‹•æ±ºå®šè¦ä¸è¦åŠ  pending æ¨£å¼
        // åŒæ™‚æˆ‘å€‘ä¹Ÿè¦é †ä¾¿ç§»é™¤ handleCellClick æ‰‹å‹•åŠ ä¸Šçš„ pending-select
        cell.classList.remove('pending-select'); 
        cell.classList.toggle('pending', pendingChoice === i);
        
        // æ¸…é™¤ç©å®¶é¡è‰²ï¼Œæº–å‚™é‡æ–°æ¨™è¨˜
        cell.classList.remove('player-1', 'player-2', 'player-3', 'player-cpu');
        
        // æª¢æŸ¥æ­·å²ç´€éŒ„ï¼Œæ±ºå®šé€™æ ¼æ˜¯èª°é¸çš„
        const log = historyLog.find(l => l.num === board[i]);
        if (log) {
            if (log.role === 'é›»è…¦') {
                cell.classList.add('player-cpu');
            } else {
                // å¾ "ç©å®¶ 1" ä¸­åˆ‡å‡ºæ•¸å­— 1
                const playerNum = log.role.split(' ')[1];
                if (playerNum) cell.classList.add(`player-${playerNum}`);
            }
        }
    });
}
// æ§åˆ¶å½ˆçª—é¡¯ç¤º/éš±è—
function toggleConfirmRestart(show) {
    document.getElementById('confirmRestartBox').style.display = show ? 'block' : 'none';
}
function resetGame() {
    // å¦‚æœéŠæˆ²é‚„æ²’é–‹å§‹ï¼ˆåœ¨ page1 å¡«è™Ÿæ¨¡å¼ï¼‰ï¼Œç›´æ¥é‡å•Ÿæ²’é—œä¿‚
    if (document.getElementById('page1').classList.contains('active')) {
        executeReset();
    } else {
        // å¦‚æœæ­£åœ¨éŠæˆ²ä¸­ï¼Œå½ˆå‡ºç¢ºèªè¦–çª—
        toggleConfirmRestart(true);
    }
}
    function executeReset() {
        toggleConfirmRestart(false);
    console.log("1. resetGame é–‹å§‹");
    document.getElementById('viewCpuBtn').disabled = true; //çœ‹é›»è…¦ç›¤é¢æ¸¬è©¦ç”¨å…ˆæ”¹ç‚ºfalseï¼Œæ­£å¼ç‰ˆæ‡‰è©²æ˜¯true
    state = 'FILL';
    selectedIndices.clear();
    cpuSelectedIndices.clear();
    historyLog = [];
    pendingChoice = null;

    // A. åˆ‡æ›é é¢é¡¯ç¤º
    const p1 = document.getElementById('page1');
    const p2 = document.getElementById('page2');
    if (p1) p1.classList.add('active');
    if (p2) p2.classList.remove('active');

    // B. åŸºç¤ UI å…§å®¹é‡è¨­
    if (displayBox) displayBox.innerText = '-';
    if (scoreEl) scoreEl.innerText = '0';
    if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
    document.getElementById('gameOver').style.display = 'none';

    const turnEl = document.getElementById('turn-indicator');
    if (turnEl) {
        turnEl.innerText = 'âœï¸ å¡«å¯«è™Ÿç¢¼ä¸­';
        turnEl.className = 'turn-label';
    }

    try {
        initGrid();
        checkButtons();
        updateStatusDisplay();

        // C. é—œéµä¿®æ­£ï¼šç›´æ¥åŸ·è¡Œ setPlayers ç¢ºä¿åˆå§‹ç‹€æ…‹ä¸‹ï¼ˆé è¨­2äººï¼‰ç¦ç”¨ç¬¬ä¸‰é †ä½
        // ç§»é™¤åŸæœ‰çš„ setTimeout ä»¥ç¢ºä¿åŒæ­¥åŸ·è¡Œ
        setPlayers(playerCount); 
        setMode(gameMode);
        setSize(gridSize);
        // åŒæ­¥æ‰€æœ‰æŒ‰éˆ• UI
        updateBtnUI('p', playerCount);
        updateBtnUI('mode', gameMode);
        updateBtnUI('order', myOrder);
        // åˆå§‹åŒ–åˆ†æ•¸é¡¯ç¤ºæ–‡å­—
        scoreEl.innerText = '0'; //scoreEl.innerText = `${pLines} / ${targetWinLines}`
        
    } catch (e) {
        console.error("åˆå§‹åŒ–éŒ¯èª¤:", e);
    }

    console.log("3. resetGame çµæŸ");

}


        // è¼”åŠ©åŠŸèƒ½
        function getWinPaths() {
            let paths = [];
            for (let i = 0; i < gridSize; i++) {
                let r = [], c = [];
                for (let j = 0; j < gridSize; j++) { r.push(i * gridSize + j); c.push(j * gridSize + i); }
                paths.push(r, c);
            }
            let d1 = [], d2 = [];
            for (let i = 0; i < gridSize; i++) { d1.push(i * gridSize + i); d2.push((i + 1) * gridSize - (i + 1)); }
            paths.push(d1, d2); return paths;
        }
        /* --- é€šç”¨ç•«ç·šå‡½å¼ï¼šåŒæ™‚æ”¯æ´ç©å®¶èˆ‡é›»è…¦ç›¤é¢ --- */
/* --- æœ€çµ‚é˜²éŒ¯ç‰ˆï¼šrenderBingoLines --- */
function renderBingoLines(containerId, canvasId, dataSet) {
    const container = document.getElementById(containerId);
    const canvas = document.getElementById(canvasId);
    
    // å¦‚æœå‚³é€²ä¾†çš„è³‡æ–™é›† (dataSet) ä¸å­˜åœ¨ï¼Œç›´æ¥è·³å‡º
    if (!container || !canvas || !dataSet) {
        console.warn("ç•«ç·šå¤±æ•—ï¼šæ‰¾ä¸åˆ°å®¹å™¨ã€ç•«å¸ƒæˆ–è³‡æ–™é›†");
        return;
    }

    // 1. åŒæ­¥å¤§å°
    canvas.width = container.offsetWidth;
    canvas.height = container.offsetHeight;
    
    const ctx_local = canvas.getContext('2d');
    ctx_local.clearRect(0, 0, canvas.width, canvas.height);
    
    // 2. æ¨£å¼
    ctx_local.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--line-color').trim() || '#51cf66';
    ctx_local.lineWidth = 3;
    ctx_local.lineCap = 'round';

    const cells = container.querySelectorAll('.cell');
    if (cells.length === 0) return;

    const r = container.getBoundingClientRect();
    const off = cells[0].offsetWidth / 2;

    // 3. åŸ·è¡Œç•«ç·š
/* --- ä¿®æ­£åç§»çš„æ ¸å¿ƒé‚è¼¯ï¼šæ”¹ç”¨ Offset --- */
    getWinPaths().forEach(path => {
        if (path.every(idx => dataSet.has(idx))) {
            // é€™è£¡ç›´æ¥å–å¾—ã€Œæ ¼å­å…ƒç´ ã€æœ¬èº«ï¼Œè€Œä¸æ˜¯å®ƒçš„ Rect
            const startCell = cells[path[0]];
            const endCell = cells[path[path.length - 1]];

            // 1. ä½¿ç”¨ offset å±¬æ€§ï¼Œé€™æœƒæŠ“å–ç›¸å°æ–¼å®¹å™¨çš„ã€Œå…§éƒ¨åº§æ¨™ã€
            // 2. é€™æ¨£å°±ä¸éœ€è¦æ¸›å» r.left æˆ– r.top äº†
            const startX = startCell.offsetLeft + off;
            const startY = startCell.offsetTop + off;
            const endX = endCell.offsetLeft + off;
            const endY = endCell.offsetTop + off;

            ctx_local.beginPath();
            ctx_local.moveTo(startX, startY);
            ctx_local.lineTo(endX, endY);
            ctx_local.stroke();
        }
    });
}
        function cpuSmartPick() {
            const paths = getWinPaths(), called = historyLog.map(l => l.num);
            let best = null, max = -1;
            for (let n = 1; n <= gridSize * gridSize; n++) {
                if (called.includes(n)) continue;
                let s = 0, idx = cpuBoard.indexOf(n);
                paths.forEach(p => { if (p.includes(idx)) s += Math.pow(10, p.filter(i => cpuSelectedIndices.has(i)).length); });
                if (s > max) { max = s; best = n; }
            }
            return best;
        }
        function startGame() { 
            state = 'PLAY'; 
            currentTurn = 1; 
            scoreEl.innerText = `0 `;//scoreEl.innerText = `${pLines} / ${targetWinLines}`
            cpuBoard = Array.from({length: gridSize*gridSize}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
            document.getElementById('page1').classList.remove('active');
            document.getElementById('page2').classList.add('active');
            checkNextTurn();
        }
        function randomFill() { board = Array.from({length: gridSize*gridSize}, (_, i) => i + 1).sort(() => Math.random() - 0.5); renderBoard(); checkButtons(); }
        function clearAll() { board.fill(null); renderBoard(); checkButtons(); }
        function cancelSelect() { pendingChoice = null; displayBox.innerText = '-'; renderBoard(); }
        function checkButtons() { startBtn.disabled = board.includes(null); }
        function toggleInfo(s) { document.getElementById('infoBox').style.display = s ? 'block' : 'none'; }
        function toggleSettings(s) { document.getElementById('settingsBox').style.display = s ? 'block' : 'none'; }
        function toggleHistory(s) { document.getElementById('historyBox').style.display = s ? 'block' : 'none'; }
        
        function updateHistoryUI() {
    const listElement = document.getElementById('logList');
    if (!listElement) return;

    if (historyLog.length === 0) {
        listElement.innerHTML = 'å°šæœªé–‹å§‹';
        return;
    }

    // ä½¿ç”¨ map ç”¢ç”Ÿ HTMLï¼Œä¸¦ç›´æ¥å¥—ç”¨ä½ æä¾›çš„é¡å
    listElement.innerHTML = historyLog.slice().map(h => {
        let colorClass = '';
        
        // æ ¹æ“šè§’è‰²å°æ‡‰åˆ°ä½ çš„ CSS é¡å
        if (h.role === "é›»è…¦") {
            colorClass = 'turn-cpu';
        } else if (h.role === "ç©å®¶ 1" || h.player === "ä½ ") {
            colorClass = 'turn-player-1';
        } else if (h.role === "ç©å®¶ 2") {
            colorClass = 'turn-player-2';
        } else if (h.role === "ç©å®¶ 3") {
            colorClass = 'turn-player-3';
        }

        // å°‡ colorClass å¥—ç”¨åœ¨æ•´è¡Œ div ä¸Šï¼Œé€™æ¨£æœƒæœ‰æ·¡æ·¡çš„èƒŒæ™¯è‰²èˆ‡é‚Šæ¡†
        // ä¸¦åŠ ä¸Š padding å’Œ border è®“æ¨£å¼é¡¯ç¾å‡ºä¾†
        return `<div class="${colorClass}" style="margin-bottom: 6px; padding: 4px 8px; border: 1px solid; border-radius: 4px; font-size: 0.9rem;">
                    <strong>[${h.player}]</strong> å–Šäº† ${h.num}
                </div>`;
    }).join('');
}

function setMode(v) {
    gameMode = v;
    const targetBtn = document.getElementById('mode' + v);
    if (targetBtn) updateBtnUI('mode', v);

    const p3Btn = document.getElementById('p3');
    if (p3Btn) {
        if (v === 'PVE') {
            p3Btn.disabled = true;
            if (playerCount === 3) setPlayers(2); 
        } else {
            p3Btn.disabled = false;
        }
    }
}

        function setSize(v) {
    gridSize = v;
    updateBtnUI('size', v);

    // å–å¾—å‹åˆ©æ¢ä»¶æŒ‰éˆ•
    const btnWin5 = document.getElementById('win5');
    const btnWin7 = document.getElementById('win7');

    if (v === 5) {
        // 5x5 æ¨¡å¼ï¼šé–€æª»å›æ­¸ 5 ç·šï¼Œä¸”ç¦ç”¨ 7 ç·šæŒ‰éˆ•
        targetWinLines = 5;
        updateBtnUI('win', 5);
        
        if (btnWin7) btnWin7.disabled = true;
        if (btnWin5) btnWin5.disabled = false; // ç¢ºä¿ 5 ç·šæ˜¯å¯ç”¨çš„
    } else if (v === 7) {
        // 7x7 æ¨¡å¼ï¼šé è¨­è·³åˆ° 7 ç·šï¼Œä½† 5 ç·šå’Œ 7 ç·šéƒ½å¯é¸
        targetWinLines = 7;
        updateBtnUI('win', 7);
        
        if (btnWin7) btnWin7.disabled = false;
        if (btnWin5) btnWin5.disabled = false;
    }
}

function setPlayers(v) {
    playerCount = v;
    // åªæœ‰åœ¨å…ƒç´ å­˜åœ¨æ™‚æ‰æ›´æ–° UI
    const targetBtn = document.getElementById('p' + v);
    if (targetBtn) updateBtnUI('p', v);

    const order3Btn = document.getElementById('order3');
    if (order3Btn) {
        if (v === 2) {
            order3Btn.disabled = true;
            if (myOrder === 3) {
                myOrder = 2; 
                if (document.getElementById('order2')) updateBtnUI('order', 2);
            }
        } else {
            order3Btn.disabled = false;
        }
    }
}
// åˆ¥å¿˜äº†æ–°å¢å°æ‡‰çš„å‹åˆ©æ¢ä»¶åˆ‡æ›å‡½å¼
function setWinLines(v) {
    targetWinLines = v;
    updateBtnUI('win', v);
}

function toggleCpuBoard(show) {
    // 1. é¸å–æ–°çš„é®ç½©å±¤ (Overlay)
    const overlay = document.getElementById('cpuBoardOverlay');
    if (!overlay) return;

    if (!show) {
        overlay.style.display = 'none';
        return;
    }

    const container = document.getElementById('cpuGridPreview');
    if (!container) return;

    // 2. å‹•æ…‹è¨­å®š Grid æ¬„æ•¸ï¼šæ ¹æ“š gridSize (5æˆ–7) è‡ªå‹•é…ç½®
    container.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
    container.innerHTML = ''; 

// 3. æ¸²æŸ“é›»è…¦ç›¤é¢å…§å®¹
    cpuBoard.forEach((num, idx) => {
        const cell = document.createElement('div');
        cell.className = 'cell'; 
        cell.innerText = num;

        const targetNum = Number(num);
        const record = historyLog.find(h => Number(h.num) === targetNum);

        if (record) {
            // é€™è£¡å°æ¥ä½ çš„ CSS é¡å
            if (record.role === "é›»è…¦") {
                cell.classList.add('player-cpu'); // å°æ‡‰ä½ çš„ç´«è‰²åœ“åœˆ
            } else {
                // å¦‚æœæ˜¯ç©å®¶ 1 å–Šçš„ï¼Œå°±å¥—ç”¨ player-1ï¼Œç©å®¶ 2 å°±å¥—ç”¨ player-2
                // æˆ‘å€‘å¾ record.role ä¸­æå–æ•¸å­—ï¼Œæˆ–æ˜¯ç›´æ¥è™•ç†å­—ä¸²
                if (record.role === "ç©å®¶ 1") {
                    cell.classList.add('player-1'); 
                } else if (record.role === "ç©å®¶ 2") {
                    cell.classList.add('player-2');
                }  else {
                    // å‚™ç”¨æ–¹æ¡ˆï¼šå¦‚æœæ˜¯ã€Œä½ ã€å–Šçš„ï¼Œé€šå¸¸å°æ‡‰ç©å®¶ 1
                    cell.classList.add('player-1');
                }
            }
        }
        
        container.appendChild(cell);
    });

    // 4. æ›´æ–°é›»è…¦é€£ç·šé€²åº¦è³‡è¨Š
    const cLines = getWinPaths().filter(path => path.every(i => cpuSelectedIndices.has(i))).length;
    const scoreInfo = document.getElementById('cpuScore');
    if (scoreInfo) {
        scoreInfo.innerText = `é›»è…¦ç›®å‰é€£ç·šï¼š${cLines} / ${targetWinLines}`;
    }

    // 5. é¡¯ç¤ºé®ç½©å±¤ (è¨­å®šç‚º flex ä»¥åˆ©å…§éƒ¨ cpu-modal-content ç½®ä¸­)
    overlay.style.display = 'flex';
    // 6. é—œéµæ–°å¢ï¼šå»¶é²ä¸€å°æ®µæ™‚é–“ç¢ºä¿ä½ˆå±€å®Œæˆå¾Œï¼Œç•«å‡ºé›»è…¦ç›¤é¢çš„é€£ç·š
    if (show) {
        setTimeout(() => {
            renderBingoLines('cpuGridPreview', 'cpuLineCanvas', cpuSelectedIndices);
        }, 200);
    }
}

        function updateBtnUI(p, v) {
    // ä¿®æ­£ï¼šä½¿ç”¨æ›´ç²¾ç¢ºçš„é¸æ“‡å™¨ï¼Œç¢ºä¿åªé¸å–äººæ•¸ã€æ¨¡å¼ã€é †ä½æŒ‰éˆ•
    // åŸæœ¬çš„ [id^="${p}"] æœƒæŠ“åˆ° page1ï¼Œç¾åœ¨æˆ‘å€‘æ’é™¤æ‰å®ƒ
    const btns = document.querySelectorAll(`.btn-group button[id^="${p}"]`);
    btns.forEach(b => b.classList.remove('active'));
    
    const activeBtn = document.getElementById(`${p}${v}`);
    if (activeBtn) activeBtn.classList.add('active');
}
        function applySettings() { toggleSettings(false); resetGame(); }
        function showGameOver(t) { 
    state = 'BINGO'; 
    // å°‡ text æ”¹å› tï¼Œç¢ºä¿æ–‡å­—èƒ½æ­£ç¢ºé¡¯ç¤ºä¸”ç¨‹å¼ä¸å ±éŒ¯
    document.getElementById('winLossText').innerText = t; 
    document.getElementById('gameOver').style.display = 'flex';

    // åªæœ‰åœ¨ PVE æ¨¡å¼çµæŸæ™‚ï¼Œæ‰å•Ÿç”¨ã€ŒæŸ¥çœ‹é›»è…¦ç›¤é¢ã€æŒ‰éˆ•
    if (gameMode === 'PVE') {
        const viewBtn = document.getElementById('viewCpuBtn');
        if (viewBtn) {
            viewBtn.disabled = false;
        }
    } 
}

    
    </script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</body>
</html>